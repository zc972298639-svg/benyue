<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æœ¬æ‚¦ç‘œä¼½ç®¡ç†åŠ©æ‰‹</title>
    <style>
        :root { --primary: #f3a683; --bg: #f8fafc; --text: #334155; --sub-text: #64748b; --red: #ef4444; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); font-family: -apple-system, sans-serif; color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* å¯¼èˆª */
        .fixed-top { background: #fff; border-bottom: 1px solid #f1f5f9; flex-shrink: 0; padding-bottom: 10px; }
        .top-bar { height: 50px; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; }
        .year-month { font-size: 18px; font-weight: bold; }
        .date-nav-bar { display: flex; align-items: center; padding: 0 10px; }
        .week-strip { flex: 1; display: flex; justify-content: space-around; }
        .week-day { display: flex; flex-direction: column; align-items: center; width: 40px; padding: 8px 0; color: var(--sub-text); font-size: 13px; cursor: pointer; }
        .week-day.active { background: #ffeadb; color: #e67e22; border-radius: 10px; font-weight: bold; }
        .nav-btn { width: 30px; text-align: center; font-size: 24px; color: var(--primary); cursor: pointer; }

        .content-body { flex: 1; overflow-y: auto; padding-bottom: 90px; }
        .hidden { display: none; }

        /* å¡ç‰‡ */
        .card { background: #fff; margin: 12px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); overflow: hidden; }
        .card-header { background: var(--primary); color: #fff; padding: 12px 15px; font-weight: bold; font-size: 14px; }
        .card-body { padding: 15px; }

        .item-box { display: flex; justify-content: space-between; align-items: center; padding: 15px; margin: 10px; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
        .time-text { font-size: 20px; font-weight: bold; color: var(--primary); }

        .m-card { border-left: 5px solid #ddd; cursor: pointer; }
        .m-card.ci { border-left-color: #ff9f43; }
        .m-card.yue { border-left-color: #a29bfe; }
        .type-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-right: 6px; color: #fff; vertical-align: middle; }

        .f-input, select { width: 100%; background: #f8fafc; padding: 14px; border-radius: 10px; border: 1px solid #eee; margin-bottom: 12px; outline: none; }
        .btn-main { background: var(--primary); color: #fff; border-radius: 25px; width: 100%; font-weight: bold; padding: 14px 0; border: none; }
        .btn-group { display: flex; gap: 8px; margin-bottom: 10px; }
        .btn-sub { flex: 1; font-size: 12px; padding: 10px; border-radius: 20px; border: 1px solid #eee; background: #fff; }

        .btn-check { background:#a7ebd9; border:none; padding:8px 15px; border-radius:8px; color:#065f46; font-weight:bold; margin-right:5px; }
        .btn-cancel { background:#fee2e2; border:none; padding:8px 15px; border-radius:8px; color:#ef4444; font-weight:bold; }

        .record-line { background: #f8fafc; padding: 10px; border-radius: 8px; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; font-size: 12px; }
        .tag-log { background: #3b82f6; color: #fff; padding: 2px 5px; border-radius: 4px; font-size: 10px; margin-right:5px; }
        .tag-app { background: #10b981; color: #fff; padding: 2px 5px; border-radius: 4px; font-size: 10px; margin-right:5px; }

        .mode-toggle { background:rgba(255,255,255,0.2); border-radius:6px; padding:2px; display: flex; gap: 2px; }
        .mode-btn { font-size:11px; padding:4px 10px; cursor:pointer; border-radius: 4px; color: #fff; opacity: 0.8; }
        .mode-btn.on { background: rgba(255,255,255,0.4); font-weight: bold; opacity: 1; }

        .tab-bar { position: fixed; bottom: 0; left: 0; right: 0; height: 75px; background: #fff; display: flex; border-top: 1px solid #f1f5f9; padding-bottom: 15px; }
        .tab-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #94a3b8; font-size: 12px; }
        .tab-item.active { color: var(--primary); font-weight: bold; }
        
        /* æ•°æ®åŒæ­¥æŒ‰é’®æ ·å¼ */
        .sync-box { display: flex; gap: 10px; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px; }
        .btn-sync { flex:1; padding:10px; border-radius:8px; font-size:12px; border:1px dashed var(--primary); background:#fffaf9; color:var(--primary); }
    </style>
</head>
<body>

    <input type="date" id="hidden-date-picker" style="position:absolute; visibility:hidden;" onchange="processRenewDate(this.value)">

    <div id="header-nav" class="fixed-top">
        <div class="top-bar">
            <div class="year-month" id="display-date">2024å¹´</div>
            <div style="font-size: 14px; color: var(--sub-text);">æœ¬æ‚¦ç‘œä¼½</div>
        </div>
        <div class="date-nav-bar">
            <div class="nav-btn" onclick="changeWeek(-1)">â€¹</div>
            <div class="week-strip" id="week-list"></div>
            <div class="nav-btn" onclick="changeWeek(1)">â€º</div>
        </div>
    </div>

    <div class="content-body" id="main-content">
        <div id="page-kanban"><div id="agenda-list"></div></div>

        <div id="page-booking" class="hidden">
            <div class="card">
                <div class="card-header">é¢„çº¦æ’è¯¾</div>
                <div class="card-body">
                    <select id="book-member-select" onchange="handleBookingDateChange(state.bookingDate)"></select>
                    <input type="date" id="book-date-input" class="f-input" onchange="handleBookingDateChange(this.value)">
                    <div id="time-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;"></div>
                    <button class="btn-main" style="margin-top:15px" onclick="submitBooking()">ç¡®è®¤é¢„çº¦</button>
                </div>
            </div>
        </div>

        <div id="page-list" class="hidden"><div id="member-list-container"></div></div>

        <div id="page-reg" class="hidden">
            <div class="card">
                <div class="card-header" id="reg-title">ä¼šå‘˜èµ„æ–™å½•å…¥</div>
                <div class="card-body">
                    <input type="text" id="reg-name" class="f-input" placeholder="çœŸå®å§“å">
                    <input type="text" id="reg-wxname" class="f-input" placeholder="å¾®ä¿¡åç§°">
                    <input type="number" id="reg-phone" class="f-input" placeholder="æ‰‹æœºå·ç ">
                    <select id="reg-type" onchange="toggleRegFields(this.value)">
                        <option value="0">æ¬¡å¡</option>
                        <option value="1">æœˆå¡</option>
                    </select>
                    <div id="field-count"><input type="number" id="reg-total" class="f-input" placeholder="æ€»æ¬¡æ•°" value="20"></div>
                    <div id="field-date" class="hidden"><input type="date" id="reg-start-date" class="f-input"></div>
                    <button class="btn-main" onclick="saveMember()">ä¿å­˜ä¼šå‘˜èµ„æ–™</button>
                </div>
            </div>
        </div>

        <div id="page-center" class="hidden">
            <div class="card">
                <div class="card-header" style="display:flex; justify-content:space-between; align-items:center;">
                    <span>è¯¾ç¨‹æ¶ˆè€—æŠ¥è¡¨</span>
                    <div class="mode-toggle">
                        <div id="mode-month" class="mode-btn on" onclick="switchReportMode('month')">æŒ‰æœˆ</div>
                        <div id="mode-year" class="mode-btn" onclick="switchReportMode('year')">æŒ‰å¹´</div>
                        <div id="mode-all" class="mode-btn" onclick="switchReportMode('all')">æ‰€æœ‰</div>
                    </div>
                </div>
                <div class="card-body">
                    <input id="report-date-input" class="f-input" onchange="renderStats()">
                    <div style="text-align:center; padding: 20px 0; border-bottom: 1px solid #f1f5f9;">
                        <div id="stat-total-lessons" style="font-size:45px; font-weight:bold; color:var(--primary)">0</div>
                        <div style="font-size:12px; color:#94a3b8" id="stat-title-label">æ¶ˆè€—èŠ‚æ•°</div>
                    </div>
                    
                    <div class="sync-box">
                        <button class="btn-sync" onclick="exportData()">ğŸ“¤ å¯¼å‡ºå¤‡ä»½</button>
                        <button class="btn-sync" onclick="importData()">ğŸ“¥ å¯¼å…¥æ•°æ®</button>
                    </div>
                    <p style="font-size:10px; color:#94a3b8; text-align:center; margin-top:8px;">* æ›´æ¢æ‰‹æœºæ—¶ï¼Œè¯·å…ˆå¯¼å‡ºå¤‡ä»½å¹¶å‘é€è‡³æ–°æ‰‹æœºå¯¼å…¥</p>
                </div>
            </div>
        </div>
    </div>

    <div class="tab-bar">
        <div class="tab-item active" onclick="switchTab('kanban')">ä»Šæ—¥çœ‹æ¿</div>
        <div class="tab-item" onclick="switchTab('booking')">é¢„çº¦æ’è¯¾</div>
        <div class="tab-item" onclick="switchTab('list')">ä¼šå‘˜æ¡£æ¡ˆ</div>
        <div class="tab-item" onclick="switchTab('reg')">èµ„æ–™å½•å…¥</div>
        <div class="tab-item" onclick="switchTab('center')">æˆ‘çš„ä¸­å¿ƒ</div>
    </div>

    <script>
        const AUTH_PWD = "5260";
        let state = {
            activeTab: 'kanban',
            currentDate: formatDate(new Date()),
            baseDate: new Date(),
            members: JSON.parse(localStorage.getItem('members')) || [],
            apps: JSON.parse(localStorage.getItem('apps')) || [],
            logs: JSON.parse(localStorage.getItem('logs')) || [],
            bookingDate: formatDate(new Date()),
            selectedTimeIdx: -1,
            reportMode: 'month',
            renewingMemberId: null
        };

        const timeRanges = [];
        for (let h = 9; h <= 20; h++) {
            for (let m = 0; m < 60; m += 15) {
                if (h === 20 && m > 0) break;
                timeRanges.push({ time: `${h}:${m === 0 ? '00' : m.toString().padStart(2, '0')}`, totalMin: h * 60 + m });
            }
        }

        function init() { renderWeek(); switchTab('kanban'); }

        // --- æ•°æ®åŒæ­¥åŠŸèƒ½ ---
        function exportData() {
            const data = {
                members: state.members,
                apps: state.apps,
                logs: state.logs
            };
            const dataStr = JSON.stringify(data);
            const blob = new Blob([dataStr], {type: "text/plain"});
            
            // å°è¯•å¤åˆ¶åˆ°å‰ªè´´æ¿
            const textArea = document.createElement("textarea");
            textArea.value = dataStr;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                alert("å¤‡ä»½æ•°æ®å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼è¯·å‘åˆ°å¾®ä¿¡å‘ç»™å¦ä¸€å°æ‰‹æœºã€‚");
            } catch (err) {
                alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å…¨é€‰æ­¤å†…å®¹å¹¶å¤åˆ¶ï¼š\n\n" + dataStr);
            }
            document.body.removeChild(textArea);
        }

        function importData() {
            const dataStr = prompt("è¯·ç²˜è´´å¦ä¸€å°æ‰‹æœºå¯¼å‡ºçš„å¤‡ä»½ä»£ç ï¼š");
            if (!dataStr) return;
            try {
                const data = JSON.parse(dataStr);
                if (data.members && data.apps) {
                    if(confirm("å¯¼å…¥å°†è¦†ç›–å½“å‰æ‰‹æœºçš„æ‰€æœ‰æ•°æ®ï¼Œç¡®å®šå—ï¼Ÿ")) {
                        state.members = data.members;
                        state.apps = data.apps;
                        state.logs = data.logs || [];
                        saveData();
                        location.reload(); // åˆ·æ–°é¡µé¢ä½¿æ•°æ®ç”Ÿæ•ˆ
                    }
                } else { alert("ä»£ç æ— æ•ˆï¼Œè¯·ç¡®ä¿å¤åˆ¶äº†å®Œæ•´çš„å¤‡ä»½ä»£ç ã€‚"); }
            } catch (e) { alert("å¯¼å…¥å¤±è´¥ï¼Œä»£ç æ ¼å¼ä¸æ­£ç¡®ã€‚"); }
        }

        // --- çœ‹æ¿/é¢„çº¦/æ¡£æ¡ˆé€»è¾‘ ---
        function switchTab(tabId) {
            state.activeTab = tabId;
            document.querySelectorAll('.tab-item').forEach((el, i) => {
                el.classList.toggle('active', ['kanban','booking','list','reg','center'][i] === tabId);
            });
            document.querySelectorAll('#main-content > div').forEach(div => div.classList.add('hidden'));
            document.getElementById(`page-${tabId}`).classList.remove('hidden');
            document.getElementById('header-nav').classList.toggle('hidden', tabId !== 'kanban');
            if(tabId === 'list') renderMemberList();
            if(tabId === 'booking') renderBookingPage();
            if(tabId === 'center') renderStats();
            if(tabId === 'kanban') renderKanban();
        }

        function renderKanban() {
            const listEl = document.getElementById('agenda-list');
            const dayApps = state.apps.filter(a => a.date === state.currentDate).sort((a,b) => a.time.localeCompare(b.time));
            if(dayApps.length === 0) { listEl.innerHTML = '<div style="text-align:center; padding:100px 0; color:#ccc">ä»Šæ—¥æ— è¯¾</div>'; return; }
            listEl.innerHTML = dayApps.map(a => {
                const m = state.members.find(mem => mem.id == a.mid) || {name: 'æœªçŸ¥'};
                return `<div class="item-box">
                    <div><div class="time-text">${a.time}</div><div style="font-size:14px">${m.name}</div></div>
                    <div>
                        ${a.status==='pending' ? `
                            <button class="btn-check" onclick="checkIn(${a.id})">ç­¾åˆ°</button>
                            <button class="btn-cancel" onclick="cancelApp(${a.id})">å–æ¶ˆ</button>
                        ` : '<span style="color:#94a3b8">å·²ç­¾åˆ°</span>'}
                    </div>
                </div>`;
            }).join('');
        }

        function checkIn(id) {
            const a = state.apps.find(i => i.id == id);
            const m = state.members.find(i => i.id == a.mid);
            if(m && m.type === 'æ¬¡å¡') { m.used++; }
            a.status = 'done'; saveData(); renderKanban();
        }

        function cancelApp(id) {
            if(confirm("ç¡®å®šå–æ¶ˆï¼Ÿ")) { state.apps = state.apps.filter(a => a.id !== id); saveData(); renderKanban(); }
        }

        function renderMemberList() {
            const container = document.getElementById('member-list-container');
            container.innerHTML = state.members.map(m => {
                const myRecords = [
                    ...state.apps.filter(a => a.mid == m.id).map(a => ({...a, tp:'app'})),
                    ...state.logs.filter(l => l.mid == m.id).map(l => ({...l, tp:'log'}))
                ].sort((a,b) => (b.date || b.opTime || "").localeCompare(a.date || a.opTime || ""));

                const recordHtml = myRecords.map(r => `
                    <div class="record-line">
                        <span><b class="${r.tp=='app'?'tag-app':'tag-log'}">${r.tp=='app'?'è¯¾':'ç»­'}</b> ${r.tp=='app'?(r.date+' '+r.time+' '+r.status):(r.opTime+' '+r.desc)}</span>
                        <span style="color:red" onclick="deleteHistory(event, '${r.tp}', ${r.id}, ${m.id})">Ã—</span>
                    </div>`).join('');

                return `
                <div class="item-box m-card ${m.type=='æ¬¡å¡'?'ci':'yue'}" onclick="toggleDetails(${m.id})">
                    <div><b>${m.name}</b> (${m.type})<br><small>${m.type=='æ¬¡å¡'?'å‰©'+(m.total-m.used)+'æ¬¡':'è‡³'+m.expDate}</small></div>
                    <div class="btn-sub" style="flex:none; width:60px; text-align:center" onclick="event.stopPropagation();renewCard(${m.id},'${m.type}')">ç»­å¡</div>
                </div>
                <div id="details-${m.id}" class="hidden" style="padding:0 15px 15px">
                    ${recordHtml || '<div style="font-size:12px;color:#ccc">æ— è®°å½•</div>'}
                    <button class="btn-sub" style="width:100%;margin-top:10px;color:red" onclick="deleteMember(${m.id})">å½»åº•åˆ é™¤ä¼šå‘˜</button>
                </div>`;
            }).join('');
        }

        // --- åŸºç¡€å·¥å…· ---
        function switchReportMode(m) { 
            state.reportMode = m; 
            document.getElementById('report-date-input').classList.toggle('hidden', m=='all');
            renderStats(); 
        }
        function renderStats() {
            let filtered = state.apps.filter(a => a.status === 'done');
            if(state.reportMode !== 'all') {
                const val = document.getElementById('report-date-input').value;
                filtered = filtered.filter(a => a.date.startsWith(val));
            }
            document.getElementById('stat-total-lessons').innerText = filtered.length;
        }
        function saveMember() {
            const name = document.getElementById('reg-name').value;
            if(!name) return alert('å§“åå¿…å¡«');
            const m = { 
                id: Date.now(), name, 
                type: document.getElementById('reg-type').value == 0 ? 'æ¬¡å¡' : 'æœˆå¡',
                total: parseInt(document.getElementById('reg-total').value)||0,
                used: 0, startDate: document.getElementById('reg-start-date').value
            };
            if(m.type==='æœˆå¡'){ let d=new Date(m.startDate||new Date()); d.setDate(d.getDate()+30); m.expDate=formatDate(d); }
            state.members.push(m); saveData(); switchTab('list');
        }
        function renewCard(id, type) {
            state.renewingMemberId = id;
            if(type === 'æ¬¡å¡') {
                const add = prompt("å¢åŠ æ¬¡æ•°ï¼š", "20");
                if(add){ 
                    const m = state.members.find(i=>i.id==id); m.total += parseInt(add);
                    state.logs.push({id:Date.now(), mid:id, opTime:formatDate(new Date()), desc:`ç»­è´¹+${add}æ¬¡`});
                    saveData(); renderMemberList();
                }
            } else { document.getElementById('hidden-date-picker').showPicker(); }
        }
        function processRenewDate(val) {
            const m = state.members.find(i=>i.id==state.renewingMemberId);
            let d = new Date(val); d.setDate(d.getDate()+30); m.expDate = formatDate(d);
            state.logs.push({id:Date.now(), mid:m.id, opTime:formatDate(new Date()), desc:`ç»­æœŸè‡³${m.expDate}`});
            saveData(); renderMemberList();
        }
        function renderBookingPage() {
            const select = document.getElementById('book-member-select');
            select.innerHTML = state.members.map((m, i) => `<option value="${i}">${m.name}</option>`).join('');
            handleBookingDateChange(state.bookingDate);
        }
        function handleBookingDateChange(val) {
            state.bookingDate = val; const grid = document.getElementById('time-grid');
            grid.innerHTML = timeRanges.map((t, i) => `<div class="time-block ${state.selectedTimeIdx==i?'on':''}" onclick="state.selectedTimeIdx=${i};handleBookingDateChange('${val}')">${t.time}</div>`).join('');
        }
        function submitBooking() {
            const mIdx = document.getElementById('book-member-select').value;
            state.apps.push({ id: Date.now(), mid: state.members[mIdx].id, date: state.bookingDate, time: timeRanges[state.selectedTimeIdx].time, status: 'pending' });
            saveData(); switchTab('kanban');
        }
        function deleteMember(id) { if(confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) { state.members=state.members.filter(m=>m.id!=id); saveData(); renderMemberList(); } }
        function deleteHistory(e,tp,rid,mid) { e.stopPropagation(); if(tp=='app'){state.apps=state.apps.filter(i=>i.id!=rid)}else{state.logs=state.logs.filter(i=>i.id!=rid)} saveData(); renderMemberList(); }
        function toggleDetails(id) { document.getElementById(`details-${id}`).classList.toggle('hidden'); }
        function selectDate(d) { state.currentDate = d; renderWeek(); renderKanban(); }
        function changeWeek(dir) { state.baseDate.setDate(state.baseDate.getDate() + (dir*7)); renderWeek(); }
        function formatDate(d) { return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0'); }
        function saveData() { localStorage.setItem('members', JSON.stringify(state.members)); localStorage.setItem('apps', JSON.stringify(state.apps)); localStorage.setItem('logs', JSON.stringify(state.logs)); }
        function toggleRegFields(v) { document.getElementById('field-count').classList.toggle('hidden', v==1); document.getElementById('field-date').classList.toggle('hidden', v==0); }
        function renderWeek() {
            const listEl = document.getElementById('week-list'); listEl.innerHTML = '';
            let start = new Date(state.baseDate); let day = start.getDay(); let diff = start.getDate() - day + (day == 0 ? -6 : 1);
            start.setDate(diff);
            for (let i = 0; i < 7; i++) {
                let d = new Date(start); d.setDate(start.getDate() + i); let dateStr = formatDate(d);
                listEl.innerHTML += `<div class="week-day ${dateStr === state.currentDate ? 'active' : ''}" onclick="selectDate('${dateStr}')"><span>${['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'][i]}</span><span>${d.getDate()}</span></div>`;
            }
            document.getElementById('display-date').innerText = state.baseDate.getFullYear() + "å¹´" + (state.baseDate.getMonth()+1) + "æœˆ";
        }
        init();
    </script>
</body>
</html>
